<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Budget Tracker</title>
  <!-- Load Google fonts and Font Awesome for icons -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Load Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Load Lottie for optional animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    /*
      The styles below combine the dark/light theme system from the existing
      budget tracker with a modern glassmorphism look.  Root variables
      define gradients and colours used throughout the app.  The layout is
      designed for mobile first but scales up gracefully on larger
      screens.  Where possible we avoid hard‑coding sizes so that
      components shrink and grow naturally.  Some of these values are
      adapted from the design provided by the user at the start of the
      conversation.
    */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Bold yet harmonious colour palette inspired by the index.html.
         We choose a limited number of strong tones to avoid clashing
         against the dark/light backgrounds.  The primary colour is a
         golden yellow, supported by a rich green, warm orange and
         confident red.  These provide enough contrast without using
         too many hues. */
      --primary-color: #eab308;   /* golden yellow */
      --success-color: #22c55e;   /* emerald green */
      --warning-color: #f97316;   /* sunset orange */
      --danger-color: #dc2626;    /* crimson red */
      --info-color: #7c3aed;      /* royal purple */

      /* Override gradient variables with solid colours to avoid gradients */
      --primary-gradient: var(--primary-color);
      --success-gradient: var(--success-color);
      --warning-gradient: var(--warning-color);
      --danger-gradient: var(--danger-color);
      /* Neutral backgrounds */
      --dark-bg: #0f0f23;
      --light-bg: #f9fafb;
      --card-bg-dark: #1a1a2e;
      --card-bg-light: #ffffff;
      /* Text colours */
      --text-primary-dark: #ffffff;
      --text-primary-light: #111827;
      --text-secondary-dark: #b8b8d4;
      --text-secondary-light: #6b7280;
      /* Glassmorphism settings */
      --glass-bg-dark: rgba(255, 255, 255, 0.05);
      --glass-bg-light: rgba(0, 0, 0, 0.05);
      --glass-border-dark: rgba(255, 255, 255, 0.15);
      --glass-border-light: rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary-dark);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: var(--light-bg);
      color: var(--text-primary-light);
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 16px 80px;
      position: relative;
    }

    /* Animated background shapes */
    .bg-animation {
      /* Disable the floating background circles for a cleaner look.  The
         original design included animated circles drifting behind the
         content.  To comply with the user's request to remove this
         distraction, we simply hide the entire animation container. */
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.1;
      pointer-events: none;
    }
    .floating-shapes {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    .shape {
      position: absolute;
      border-radius: 50%;
      background: var(--primary-gradient);
      animation: float 25s infinite ease-in-out;
    }
    .shape:nth-child(1) { width: 80px; height: 80px; top: 20%; left: 10%; animation-delay: 0s; }
    .shape:nth-child(2) { width: 60px; height: 60px; top: 65%; right: 10%; animation-delay: 5s; }
    .shape:nth-child(3) { width: 120px; height: 120px; bottom: 15%; left: 20%; animation-delay: 10s; }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
      25% { transform: translateY(-20px) rotate(90deg); opacity: 0.6; }
      50% { transform: translateY(0) rotate(180deg); opacity: 0.3; }
      75% { transform: translateY(-10px) rotate(270deg); opacity: 0.6; }
    }

    /* Header with greeting and actions */
    .header {
      margin-top: 24px;
      margin-bottom: 24px;
    }
    .user-greeting {
      background: var(--glass-bg-dark);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border-dark);
      border-radius: 20px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    body.light .user-greeting {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
    }
    .user-greeting::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: shimmer 3s infinite;
    }
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    .greeting-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .greeting-text h1 {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 4px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .greeting-subtitle {
      color: var(--text-secondary-dark);
      font-size: 14px;
    }
    body.light .greeting-subtitle { color: var(--text-secondary-light); }
    .profile-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--success-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: white;
      box-shadow: 0 8px 32px rgba(79, 172, 254, 0.3);
      text-transform: uppercase;
    }

    /* Balance card */
    .balance-card {
      background: var(--glass-bg-dark);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border-dark);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      /* 3D depth: layered shadows for a card floating effect */
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 12px 24px rgba(0, 0, 0, 0.25);
    }
    body.light .balance-card {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.08);
    }
    .balance-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .balance-label {
      color: var(--text-secondary-dark);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    body.light .balance-label { color: var(--text-secondary-light); }
    .balance-amount {
      font-size: 36px;
      font-weight: 900;
      margin-bottom: 16px;
      background: var(--success-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .balance-trend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary-dark);
    }
    body.light .balance-trend { color: var(--text-secondary-light); }
    .trend-icon {
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .balance-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
    }
    .stat-card {
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    body.light .stat-card {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
    }
    .stat-card:hover {
      transform: translateY(-4px);
      /* Enhanced hover shadow for 3D lift */
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25), 0 16px 32px rgba(0, 0, 0, 0.2);
    }
    .stat-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      font-size: 16px;
      color: white;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      color: var(--text-secondary-dark);
    }
    body.light .stat-label { color: var(--text-secondary-light); }
    .stat-amount {
      font-size: 18px;
      font-weight: 800;
    }
    /* Use colour variables for income/expense amounts to ensure
       sufficient contrast in both themes. */
    .income-card .stat-amount {
      /* Ensure a single, consistent colour is used for income amounts across
         both dark and light themes.  We remove conflicting declarations
         further below and use the success/danger variables defined in
         :root for strong contrast. */
      color: var(--success-color);
    }
    .expense-card .stat-amount {
      color: var(--danger-color);
    }
    .income-card .stat-icon { background: var(--success-gradient); }
    .expense-card .stat-icon { background: var(--danger-gradient); }
    /* The original stylesheet defined duplicate colours for the income and
       expense amounts (#00f2fe and #fa709a), which clashed with the
       surrounding backgrounds and sometimes rendered poorly on light
       themes.  These overrides have been removed so that the colours
       above take effect consistently. */

    /* Budget goals */
    .budget-goals {
      margin-bottom: 24px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary-dark);
    }
    body.light .section-title { color: var(--text-primary-light); }
    .view-all-btn {
      background: none;
      border: none;
      color: #4facfe;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .view-all-btn:hover { color: #667eea; }

    .budget-card {
      background: var(--card-bg-dark);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      /* 3D card shadow */
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.25);
    }
    body.light .budget-card {
      background: var(--card-bg-light);
      border-color: rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.05);
    }
    .budget-card:hover {
      transform: translateY(-2px);
      /* stronger elevation on hover */
      box-shadow: 0 8px 16px rgba(0,0,0,0.25), 0 16px 32px rgba(0,0,0,0.2);
    }
    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .budget-category {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
    }
    .category-info h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
      color: var(--text-primary-dark);
    }
    body.light .category-info h3 { color: var(--text-primary-light); }
    .category-info p {
      font-size: 12px;
      color: var(--text-secondary-dark);
    }
    body.light .category-info p { color: var(--text-secondary-light); }
    .budget-amount {
      text-align: right;
    }
    .spent-amount {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 2px;
    }
    .budget-limit {
      font-size: 12px;
      color: var(--text-secondary-dark);
    }
    body.light .budget-limit { color: var(--text-secondary-light); }
    .progress-container {
      margin-top: 12px;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    body.light .progress-bar {
      background: rgba(0, 0, 0, 0.1);
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.8s ease;
      position: relative;
    }
    .progress-percentage {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary-dark);
      margin-top: 4px;
      text-align: right;
    }
    body.light .progress-percentage { color: var(--text-secondary-light); }

    /* Quick actions */
    .quick-actions {
      display: grid;
      /* Display all quick actions on a single row.  There are four buttons
         (Add Expense, Add Income, Export and Settings) so we explicitly
         create four equal columns.  This prevents wrapping on wider
         screens and aligns with the requirement for four columns on
         desktop/tablet layouts. */
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .action-btn {
      background: var(--glass-bg-dark);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border-dark);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    body.light .action-btn {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
    }
    .action-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    }
    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-gradient);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .action-btn:hover::before { opacity: 0.1; }
    .action-icon {
      font-size: 20px;
      margin-bottom: 8px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .action-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary-dark);
    }
    body.light .action-label { color: var(--text-secondary-light); }

    /*
      Horizontal back bar used on non‑dashboard pages.  Instead of the
      floating circular button from the previous design, the back bar
      sits underneath the greeting panel and provides both an icon and
      a descriptive label.  It uses the same glassmorphism backdrop as
      other cards to maintain visual cohesion.  Adjust padding and
      spacing so it does not overlap other elements.  The bar uses
      `cursor: pointer` to indicate interactivity.
    */
    .back-bar {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 12px;
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      width: fit-content;
    }
    .back-bar i {
      font-size: 16px;
      color: var(--primary-gradient);
    }
    .back-bar span {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary-dark);
    }
    body.light .back-bar {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
    }
    body.light .back-bar span {
      color: var(--text-secondary-light);
    }

    /* AI insights */
    .ai-insights {
      background: var(--glass-bg-dark);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border-dark);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 24px;
      /* add shadow for depth */
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.25);
    }
    body.light .ai-insights {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.05);
    }
    .ai-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .ai-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .ai-title {
      font-size: 16px;
      font-weight: 700;
    }
    .insight-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    body.light .insight-item { background: rgba(0, 0, 0, 0.05); }
    .insight-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
    }
    .insight-text {
      font-size: 14px;
      color: var(--text-secondary-dark);
      line-height: 1.4;
    }
    body.light .insight-text { color: var(--text-secondary-light); }
    .tip-icon { background: var(--success-gradient); }
    .warning-icon { background: var(--warning-gradient); }
    .trend-icon-small { background: var(--primary-gradient); }

    /* Charts & Estimation Section */
    .charts-section {
      margin-bottom: 24px;
    }
    .charts-section .section-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 12px;
      color: var(--text-primary-dark);
    }
    body.light .charts-section .section-title {
      color: var(--text-primary-light);
    }
    .chart-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 480px) {
      .chart-grid { grid-template-columns: 1fr 1fr; }
    }
    .chart-card {
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      border-radius: 16px;
      padding: 12px;
      /* unified card shadow */
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      transition: transform 0.3s;
    }
    body.light .chart-card {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.05);
    }
    .chart-card:hover {
      transform: translateY(-4px);
    }
    .chart-card canvas {
      width: 100% !important;
      height: 200px !important;
    }
    .estimation-card {
      margin-top: 20px;
      padding: 16px;
      border-radius: 16px;
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      /* consistent 3D shadow */
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      transition: transform 0.3s;
    }
    body.light .estimation-card {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.05);
    }

    /* Navigation Menu & Overlay
       The floating add button has been replaced with a hamburger menu that
       reveals navigation items.  When the menu is open, an overlay
       covers the rest of the page with a subtle blur to draw focus to
       the menu. */
    .nav-menu {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary-gradient);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      transition: transform 0.3s;
    }
    .nav-menu.open .nav-toggle {
      transform: rotate(90deg);
    }
    .nav-items {
      display: none;
      flex-direction: column;
      margin-bottom: 12px;
    }
    .nav-menu.open .nav-items {
      display: flex;
    }
    .nav-item {
      width: 48px;
      height: 48px;
      margin-top: 8px;
      border-radius: 50%;
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      color: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      backdrop-filter: blur(10px);
    }
    .nav-item:hover {
      transform: translateY(-2px);
      background: var(--primary-gradient);
      color: white;
    }
    body.light .nav-item {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      color: var(--primary-gradient);
    }
    /* Overlay covering the page when the nav menu is open */
    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
      z-index: 999;
    }
    .nav-overlay.show {
      opacity: 1;
      visibility: visible;
    }

/*
  In light mode the navigation overlay should not darken the UI.  Use a
  semi‑transparent white overlay instead of the default black.  This
  rule overrides the base overlay background defined above when
  `body.light` is present.
*/
body.light .nav-overlay {
  background: rgba(255, 255, 255, 0.4);
}
    .estimation-card:hover {
      transform: translateY(-2px);
    }
    .estimation-card h4 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary-dark);
    }
    body.light .estimation-card h4 {
      color: var(--text-primary-light);
    }
    .estimation-card p {
      font-size: 14px;
      color: var(--text-secondary-dark);
    }
    body.light .estimation-card p {
      color: var(--text-secondary-light);
    }

    /* Daily summary card for today's income and expense */
    .daily-summary {
      display: flex;
      justify-content: space-between;
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.25);
    }
    body.light .daily-summary {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.05);
    }
    .daily-item {
      flex: 1;
      text-align: center;
    }
    .daily-item span {
      display: block;
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .daily-item.income span { color: var(--success-color); }
    .daily-item.expense span { color: var(--danger-color); }
    .daily-item label {
      font-size: 12px;
      color: var(--text-secondary-dark);
    }
    body.light .daily-item label { color: var(--text-secondary-light); }

    /* Search bar within transactions section */
    .transaction-search {
      position: relative;
      margin-bottom: 16px;
    }
    .transaction-search input {
      width: 100%;
      padding: 10px 36px 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--glass-border-dark);
      background: var(--glass-bg-dark);
      color: var(--text-primary-dark);
      font-size: 14px;
    }
    body.light .transaction-search input {
      border-color: var(--glass-border-light);
      background: var(--glass-bg-light);
      color: var(--text-primary-light);
    }
    .transaction-search input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(234,179,8,0.3);
    }
    .transaction-search i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary-dark);
    }
    body.light .transaction-search i { color: var(--text-secondary-light); }

    /* Avatar selector styles */
    .avatar-options {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .avatar-option {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
    }
    body.light .avatar-option {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
    }
    .avatar-option.selected {
      /* Selected avatar uses the primary colour regardless of theme.  Use
         !important to override light/dark backgrounds on the base class. */
      background: var(--primary-color) !important;
      color: var(--dark-bg) !important;
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .avatar-option.selected i {
      color: var(--dark-bg) !important;
    }
    .avatar-option i {
      font-size: 20px;
    }

    /* Custom styled selects for category, theme and language */
    select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--text-primary-dark);
      width: 100%;
      transition: background 0.3s, border-color 0.3s;
    }
    body.light select {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      color: var(--text-primary-light);
    }
    select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* Transactions */
    .transactions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .filter-pills {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .filter-pill {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary-dark);
      transition: all 0.3s ease;
    }
    body.light .filter-pill { background: rgba(0, 0, 0, 0.1); color: var(--text-secondary-light); }
    .filter-pill.active {
      background: var(--primary-gradient);
      color: white;
    }
    .transaction-card {
      background: var(--card-bg-dark);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      /* 3D shadow for transaction card */
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.25);
    }
    body.light .transaction-card {
      background: var(--card-bg-light);
      border-color: rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.05);
    }
    .transaction-card:hover {
      transform: translateX(4px);
      /* deeper shadow on hover for 3D effect */
      box-shadow: 0 8px 16px rgba(0,0,0,0.25), 0 16px 32px rgba(0,0,0,0.2);
    }
    .transaction-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .transaction-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }
    .transaction-details {
      flex: 1;
    }
    .transaction-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary-dark);
    }
    body.light .transaction-title { color: var(--text-primary-light); }
    .transaction-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary-dark);
    }
    body.light .transaction-meta { color: var(--text-secondary-light); }
    .transaction-amount {
      text-align: right;
    }
    .amount-value {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .amount-type {
      font-size: 11px;
      color: var(--text-secondary-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    body.light .amount-type { color: var(--text-secondary-light); }
    .transaction-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .txn-action-btn {
      background: rgba(0, 0, 0, 0.3);
      border: none;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      color: #fff;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    body.light .txn-action-btn {
      background: rgba(255, 255, 255, 0.3);
      color: #000;
    }
    .txn-action-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      transform: scale(1.1);
    }
    body.light .txn-action-btn:hover { background: rgba(255, 255, 255, 0.5); }

    /* Floating add button */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary-gradient);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .fab:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
    }

    /* Achievement popup */
    .achievement {
      position: fixed;
      top: 20px;
      right: -320px;
      background: var(--glass-bg-dark);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border-dark);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      transition: right 0.5s ease;
      z-index: 1001;
      max-width: 280px;
      color: var(--text-primary-dark);
    }
    body.light .achievement {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      color: var(--text-primary-light);
    }
    .achievement.show { right: 20px; }
    .achievement-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--warning-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      animation: celebrate 0.6s ease;
    }
    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .achievement-text h4 {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    .achievement-text p {
      font-size: 12px;
      color: var(--text-secondary-dark);
    }
    body.light .achievement-text p { color: var(--text-secondary-light); }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--card-bg-dark);
      border-radius: 20px;
      padding: 24px;
      max-width: 360px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.7) translateY(50px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    body.light .modal-content { background: var(--card-bg-light); }
    .modal.active .modal-content { transform: scale(1) translateY(0); }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      color: var(--text-primary-dark);
    }
    body.light .modal-title { color: var(--text-primary-light); }
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary-dark);
    }

    /* Alert panel */
    /*
      The alert panel covers the entire viewport with a translucent
      backdrop and centres a small message box on top.  It uses the
      glassmorphism aesthetic similar to other modals but with a
      simplified layout.  The active class toggles visibility and
      animates opacity for a smooth appearance.  The button uses the
      existing btn-save class for consistency.
    */
    .alert-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .alert-panel.active {
      opacity: 1;
      visibility: visible;
    }
    .alert-content {
      background: var(--glass-bg-dark);
      border: 1px solid var(--glass-border-dark);
      border-radius: 16px;
      padding: 24px;
      width: 80%;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      color: var(--text-primary-dark);
    }
    body.light .alert-content {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      color: var(--text-primary-light);
    }
    #alertMessage {
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.4;
    }
    body.light .form-label { color: var(--text-primary-light); }
    .form-input,
    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary-dark);
      background: var(--glass-bg-dark);
      transition: all 0.3s ease;
    }
    body.light .form-input,
    body.light .form-select {
      border-color: rgba(0, 0, 0, 0.1);
      color: var(--text-primary-light);
      background: var(--glass-bg-light);
    }
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    /* Ensure options are visible in dark and light themes */
    .form-select option {
      background: var(--card-bg);
      color: var(--text-primary-dark);
    }
    body.light .form-select option {
      background: var(--card-bg-light);
      color: var(--text-primary-light);
    }
    .form-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 20px;
      position: relative;
    }
    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    .btn-cancel {
      background: var(--glass-bg-dark);
      border: 2px solid var(--glass-border-dark);
      color: var(--text-primary-dark);
    }
    body.light .btn-cancel {
      background: var(--glass-bg-light);
      border-color: var(--glass-border-light);
      color: var(--text-primary-light);
    }
    .btn-cancel:hover { transform: translateY(-2px); }
    .btn-save {
      background: var(--primary-gradient);
      color: #000;
    }
    .btn-save:hover { transform: translateY(-2px); opacity: 0.9; }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
    }
    .loading-overlay.active { display: flex; }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .container { padding: 0 12px 80px; }
      .balance-amount { font-size: 28px; }
      .quick-actions { grid-template-columns: repeat(2, 1fr); }
      .fab { bottom: 20px; right: 20px; }
    }

    /*
      Override the default grid layout for the login modal's buttons.
      When the login modal is displayed, stack all buttons vertically
      and ensure each button spans the full width of the modal.  This
      prevents the "Login", "Continue as Guest" and "Login with Google"
      buttons from overlapping on narrow mobile screens.
    */
    #loginModal .form-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #loginModal .form-buttons .btn {
      width: 100%;
    }
    /* Style the Google login button with Google's brand colour and center its text */
    #loginModal .google-btn {
      background: #4285F4;
      color: #fff;
      text-align: center;
    }

    /* Hide navigation controls whenever the login modal is active.  This
       rule uses the general sibling selector to target the navigation
       elements that appear later in the DOM.  It complements the JS
       fallback in openLoginModal/closeLoginModal and ensures the nav
       button never overlaps the login form. */
    #loginModal.active ~ #navMenu,
    #loginModal.active ~ #navOverlay {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="bg-animation">
    <div class="floating-shapes">
      <div class="shape"></div>
      <div class="shape"></div>
      <div class="shape"></div>
    </div>
  </div>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="user-greeting">
        <div class="greeting-content">
          <div class="greeting-text">
            <h1 id="greetingMessage">Good Evening!</h1>
            <p class="greeting-subtitle" id="greetingSubtitle">Ready to track your finances?</p>
          </div>
          <!-- Avatar uses a Font Awesome user icon instead of the first letter -->
          <div class="profile-avatar" id="profileAvatar"><i class="fas fa-user"></i></div>
        </div>
      </div>
    </div>
    <!-- Balance Card -->
    <div class="balance-card" data-page="dashboard">
      <div class="balance-header">
        <div class="balance-label" id="availableBalanceLabel">Available Balance</div>
        <div class="balance-amount" id="availableBalance">Rp 0</div>
        <div class="balance-trend" id="balanceTrend">
          <i class="fas fa-trending-up trend-icon"></i>
          <span id="balanceTrendText">+0% from last month</span>
        </div>
      </div>
      <div class="balance-stats">
        <div class="stat-card income-card">
          <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
          <div class="stat-label" id="monthlyIncomeLabel">Monthly Income</div>
          <div class="stat-amount" id="monthlyIncome">+Rp 0</div>
        </div>
        <div class="stat-card expense-card">
          <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
          <div class="stat-label" id="monthlyExpenseLabel">Monthly Expense</div>
          <div class="stat-amount" id="monthlyExpense">-Rp 0</div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Section (moved above AI Insights) -->
    <div class="quick-actions" data-page="dashboard">
      <div class="action-btn" id="quickAddExpense">
        <i class="fas fa-minus action-icon"></i>
        <span class="action-label">Add Expense</span>
      </div>
      <div class="action-btn" id="quickAddIncome">
        <i class="fas fa-plus action-icon"></i>
        <span class="action-label">Add Income</span>
      </div>
      <div class="action-btn" id="quickExport">
        <i class="fas fa-download action-icon"></i>
        <span class="action-label">Export</span>
      </div>
      <div class="action-btn" id="quickSettings">
        <i class="fas fa-gear action-icon"></i>
        <span class="action-label">Settings</span>
      </div>
    </div>

    <!-- AI Insights Card (moved below Balance Card) -->
    <div class="ai-insights" data-page="dashboard">
      <div class="ai-header">
        <div class="ai-icon"><i class="fas fa-lightbulb"></i></div>
        <div class="ai-title" id="aiTitle">AI Insights</div>
      </div>
      <div id="insightsList"></div>
    </div>

    <!-- Budget Goals Section -->
    <div class="budget-goals" data-page="dashboard">
      <div class="section-header">
        <h2 class="section-title" id="budgetGoalsTitle">Budget Goals</h2>
        <!-- Clicking this button will open the settings modal so users can edit their budgets.  We call
             the globally exposed openSettingsModal function to ensure it always resolves. -->
        <button class="view-all-btn" id="viewAllBudgets" onclick="openSettingsModal(); return false;">Edit Budgets</button>
      </div>
      <div id="budgetCards"></div>
    </div>
    <!-- AI Insights Card relocated above.  Original position hidden to avoid duplicate IDs. -->
    <!-- <div class="ai-insights" style="display:none;"><div class="ai-header"><div class="ai-icon"><i class="fas fa-lightbulb"></i></div><div class="ai-title" id="aiTitle">AI Insights</div></div><div id="insightsList"></div></div> -->
    <!-- Charts & Estimation Section -->
    <!--
      This section renders a set of financial charts and a simple projection
      of the end‑of‑month balance.  The charts use Chart.js and are
      updated whenever transactions change.  The estimation card displays
      a projected balance based on the average daily net change so far in
      the current month.
    -->
    <div id="chartsSection" class="charts-section" data-page="charts">
      <!-- Back bar for charts page -->
      <div class="back-bar" id="chartsBackBar">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Dashboard</span>
      </div>
      <h3 class="section-title" id="chartsTitle">Financial Charts</h3>
      <div class="chart-grid">
        <div class="chart-card">
          <canvas id="incomeExpenseChart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="categoryPieChart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="balanceTrendChart" height="200"></canvas>
        </div>
        <!-- Added a fourth chart for a rolling six‑month summary.  This
             bar chart compares monthly income and expenses over the last
             six months, giving users insight into longer‑term trends. -->
        <div class="chart-card">
          <canvas id="monthlySummaryChart" height="200"></canvas>
        </div>
      </div>
      <div class="estimation-card">
        <h4 id="estimationTitle">Projected Balance</h4>
        <p id="estimationText">--</p>
      </div>
    </div>

    <!-- Transactions Section -->
    <div class="transactions-section" data-page="transactions">
      <!-- Back bar for transactions page -->
      <div class="back-bar" id="transactionsBackBar">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Dashboard</span>
      </div>
      <div class="transactions-header">
        <h2 class="section-title" id="transactionsTitle">Recent Transactions</h2>
      </div>
      <!-- Daily summary of today's income & expense -->
      <div class="daily-summary" id="dailySummary">
        <div class="daily-item income">
          <span id="dailyIncome">+Rp 0</span>
          <label id="dailyIncomeLabel">Today Income</label>
        </div>
        <div class="daily-item expense">
          <span id="dailyExpense">-Rp 0</span>
          <label id="dailyExpenseLabel">Today Expense</label>
        </div>
      </div>
      <!-- Search bar for filtering transactions -->
      <div class="transaction-search">
        <input type="text" id="transactionSearch" placeholder="Search transactions..." />
        <i class="fas fa-search"></i>
      </div>
      <div class="filter-pills" id="filterPills">
        <button class="filter-pill active" data-filter="all">All</button>
        <button class="filter-pill" data-filter="income">Income</button>
        <button class="filter-pill" data-filter="expense">Expense</button>
      </div>
      <div id="transactionsList"></div>
    </div>

  </div>


  <!-- Login Modal -->
  <!--
    Simple login modal that asks for email and password.  Users can
    authenticate with predefined credentials or continue as a guest.
    When logged in, the user's name is derived from their email for
    greeting purposes.  No backend authentication occurs; this is
    purely for demonstration and offline use.
  -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h3 class="modal-title">Login</h3>
      <div class="form-group">
        <label class="form-label" for="loginEmail">Email</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" />
      </div>
      <div class="form-group">
        <label class="form-label" for="loginPassword">Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" />
      </div>
      <div class="form-buttons">
        <button class="btn btn-save" id="loginBtnEmail">Login</button>
        <button class="btn btn-save" id="guestBtn">Continue as Guest</button>
        <!-- Button for Google authentication -->
        <button class="btn btn-save google-btn" id="loginBtnGoogle">Login with Google</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <!--
    Custom confirmation modal used for actions like deleting a transaction.
    This modal presents a message and two actions: confirm and cancel.
  -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <p id="confirmMessage" style="margin-bottom:20px; font-size:14px; text-align:center;"></p>
      <div class="form-buttons">
        <button class="btn btn-cancel" id="confirmNo">Cancel</button>
        <button class="btn btn-save" id="confirmYes">Yes</button>
      </div>
    </div>
  </div>

  <!-- Alert Panel -->
  <!--
    A simple custom alert panel used to display error or informational messages.
    This replaces the default browser alert() so that messaging can match the
    application's glassmorphism styling and colour palette.  The panel
    consists of a message and a single button to dismiss it.  The styling
    adapts automatically to the current light/dark theme using the same
    variables defined in :root.  To show an alert, call openAlert(message).
  -->
  <div class="alert-panel" id="alertPanel">
    <div class="alert-content">
      <p id="alertMessage"></p>
      <button class="btn btn-save" id="alertOk">OK</button>
    </div>
  </div>
  <!-- Navigation menu (replaces floating add button) -->
  <div class="nav-menu" id="navMenu">
    <button class="nav-toggle" id="navToggle"><i class="fas fa-bars"></i></button>
    <div class="nav-items">
      <button class="nav-item" data-target="dashboard" title="Dashboard"><i class="fas fa-home"></i></button>
      <button class="nav-item" data-target="transactions" title="Transactions"><i class="fas fa-list"></i></button>
      <button class="nav-item" data-target="charts" title="Charts"><i class="fas fa-chart-line"></i></button>
      <!-- Logout button; uses the same nav-item style for consistency -->
      <button class="nav-item" id="logoutBtn" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </div>
  <!-- Overlay that blurs the content when navigation menu is open -->
  <div class="nav-overlay" id="navOverlay"></div>
  <!-- Achievement Popup -->
  <div class="achievement" id="achievementPopup">
    <div class="achievement-icon"><i class="fas fa-trophy"></i></div>
    <div class="achievement-text">
      <h4 id="achievementTitle">Congratulations!</h4>
      <p id="achievementMessage">You've reached a milestone.</p>
    </div>
  </div>
  <!-- Add/Edit Transaction Modal -->
  <div class="modal" id="transactionModal">
    <div class="modal-content">
      <h3 class="modal-title" id="transactionModalTitle">Add Transaction</h3>
      <div class="form-group">
        <label class="form-label" id="labelType">Type</label>
        <select class="form-select" id="transactionType">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" id="labelAmount">Amount (Rp)</label>
        <input type="number" class="form-input" id="transactionAmount" min="1" placeholder="0" />
      </div>
      <div class="form-group">
        <label class="form-label" id="labelCategory">Category</label>
        <select class="form-select" id="transactionCategory">
          <option value="food">Food & Dining</option>
          <option value="shopping">Shopping</option>
          <option value="transport">Transport</option>
          <option value="entertainment">Entertainment</option>
          <option value="salary">Salary</option>
          <option value="freelance">Freelance</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" id="labelDesc">Description</label>
        <input type="text" class="form-input" id="transactionDesc" placeholder="Description" />
      </div>
      <div class="form-buttons">
        <button class="btn btn-cancel" id="transactionCancel">Cancel</button>
        <button class="btn btn-save" id="transactionSave">Save</button>
        <div class="loading-overlay" id="transactionLoading"><i class="fa-solid fa-spinner fa-spin"></i></div>
      </div>
    </div>
  </div>
  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h3 class="modal-title" id="settingsTitle">Settings</h3>
      <div class="form-group">
        <label class="form-label" id="labelName">Name</label>
        <input type="text" class="form-input" id="userName" placeholder="Your name" />
      </div>
      <div class="form-group">
        <label class="form-label" id="labelTheme">Theme</label>
        <select class="form-select" id="themeSelect">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" id="labelLanguage">Language</label>
        <select class="form-select" id="languageSelect">
          <option value="en">English</option>
          <option value="id">Bahasa Indonesia</option>
        </select>
      </div>

      <!-- Avatar selection -->
      <div class="form-group">
        <label class="form-label" id="labelAvatar">Avatar</label>
        <div class="avatar-options" id="avatarOptions">
          <label class="avatar-option" data-avatar="user">
            <input type="radio" name="avatar" value="user" hidden />
            <i class="fas fa-user"></i>
          </label>
          <label class="avatar-option" data-avatar="cat">
            <input type="radio" name="avatar" value="cat" hidden />
            <i class="fas fa-cat"></i>
          </label>
          <label class="avatar-option" data-avatar="flower">
            <input type="radio" name="avatar" value="flower" hidden />
            <i class="fas fa-seedling"></i>
          </label>
        </div>
      </div>
      <!-- Budget inputs will be dynamically generated here -->
      <div class="form-group" id="budgetInputsContainer">
        <label class="form-label" id="labelBudgets">Budgets (IDR)</label>
        <div id="budgetInputs"></div>
      </div>
      <div class="form-buttons">
        <button class="btn btn-cancel" id="settingsCancel">Cancel</button>
        <button class="btn btn-save" id="settingsSave">Save</button>
        <!-- New button to reset all data (transactions and budgets) back to their
             default values.  This spans both columns to clearly separate it
             from the Cancel/Save actions. -->
        <button class="btn btn-cancel" id="resetDataBtn" style="grid-column: span 2; margin-top: 8px;">
          Reset Data
        </button>
      </div>
    </div>
  </div>
  <script type="module">
    /*
      The script below implements the core functionality of the enhanced
      budget tracker.  Data persistence is handled via localStorage
      under the keys 'ebt_transactions' and 'ebt_settings'.  The file
      avoids any backend dependencies so it runs entirely offline.
    */
    // Import Firebase modules for app, analytics, auth and Firestore
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    // Firebase configuration provided by user
    const firebaseConfig = {
      apiKey: "AIzaSyBmd6GmGBF4wsGmOsmpl8rpgBL-5rRExiA",
      authDomain: "endless-bank-462022-v5.firebaseapp.com",
      projectId: "endless-bank-462022-v5",
      storageBucket: "endless-bank-462022-v5.firebasestorage.app",
      messagingSenderId: "49352956283",
      appId: "1:49352956283:web:7c85f7d2aec44ee6ae05de",
      measurementId: "G-QK32DHVH23"
    };

    // Initialize Firebase app, analytics, Firestore and auth
    const firebaseApp = initializeApp(firebaseConfig);
    const analytics = getAnalytics(firebaseApp);
    const db = getFirestore(firebaseApp);
    const auth = getAuth(firebaseApp);
    const googleProvider = new GoogleAuthProvider();

    (() => {
      // Utility for formatting currency in Indonesian Rupiah without decimals
      function formatCurrency(amount) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
      }

      // Default budgets per category (IDR)
      const DEFAULT_BUDGETS = {
        food: 1000000,
        shopping: 800000,
        transport: 500000,
        entertainment: 600000,
        salary: Infinity,
        freelance: Infinity,
        other: 500000
      };

      // Category metadata for icons and colours (for cards and progress bars)
      const CATEGORY_META = {
        // Colours mapped to a restrained palette.  Multiple categories share
        // the same base colours to avoid an overly busy look while still
        // maintaining distinction in charts.  Colours reflect the CSS root
        // variables defined above.
        food: { name: { en: 'Food & Dining', id: 'Makanan & Minuman' }, icon: 'fa-utensils', color: '#f97316' },
        shopping: { name: { en: 'Shopping', id: 'Belanja' }, icon: 'fa-cart-shopping', color: '#7c3aed' },
        transport: { name: { en: 'Transport', id: 'Transportasi' }, icon: 'fa-car', color: '#eab308' },
        entertainment: { name: { en: 'Entertainment', id: 'Hiburan' }, icon: 'fa-gamepad', color: '#7c3aed' },
        salary: { name: { en: 'Salary', id: 'Gaji' }, icon: 'fa-money-bill', color: '#22c55e' },
        freelance: { name: { en: 'Freelance', id: 'Freelance' }, icon: 'fa-briefcase', color: '#eab308' },
        other: { name: { en: 'Other', id: 'Lainnya' }, icon: 'fa-ellipsis', color: '#22c55e' }
      };

      // Mapping between avatar identifiers and Font Awesome icons.  Users
      // can choose from a human, cat or flower avatar.  If more
      // animations are desired later (e.g. Lottie), they could be
      // integrated here by storing URLs instead of class names.
      const AVATAR_ICONS = {
        user: 'fa-user',
        cat: 'fa-cat',
        flower: 'fa-seedling'
      };

      // Translations for interface text
      const TRANSLATIONS = {
        en: {
          availableBalance: 'Available Balance',
          monthlyIncome: 'Monthly Income',
          monthlyExpense: 'Monthly Expense',
          budgetGoals: 'Budget Goals',
          editBudgets: 'Edit Budgets',
          addExpense: 'Add Expense',
          addIncome: 'Add Income',
          export: 'Export',
          exportCsv: 'Export CSV',
          settings: 'Settings',
          aiInsights: 'AI Insights',
          recentTransactions: 'Recent Transactions',
          type: 'Type',
          amount: 'Amount (Rp)',
          category: 'Category',
          description: 'Description',
          cancel: 'Cancel',
          save: 'Save',
          name: 'Name',
          theme: 'Theme',
          language: 'Language',
          budgets: 'Budgets (IDR)',
          dark: 'Dark',
          light: 'Light',
          editTransaction: 'Edit Transaction',
          addTransaction: 'Add Transaction',
          noTransactions: 'No transactions',
          today: 'today'
        , financialCharts: 'Financial Charts'
        , projectedBalance: 'Projected Balance'
        , avatar: 'Avatar'
        , searchPlaceholder: 'Search transactions...'
        , noResults: 'No transactions found'
        , todayIncome: 'Today Income'
        , todayExpense: 'Today Expense'
        , sixMonthSummary: '6‑Month Income vs Expense'
        , resetData: 'Reset Data'
        },
        id: {
          availableBalance: 'Saldo Tersedia',
          monthlyIncome: 'Pendapatan Bulanan',
          monthlyExpense: 'Pengeluaran Bulanan',
          budgetGoals: 'Target Anggaran',
          editBudgets: 'Ubah Anggaran',
          addExpense: 'Tambah Pengeluaran',
          addIncome: 'Tambah Pemasukan',
          export: 'Ekspor',
          exportCsv: 'Ekspor CSV',
          settings: 'Pengaturan',
          aiInsights: 'Wawasan AI',
          recentTransactions: 'Transaksi Terbaru',
          type: 'Jenis',
          amount: 'Jumlah (Rp)',
          category: 'Kategori',
          description: 'Deskripsi',
          cancel: 'Batal',
          save: 'Simpan',
          name: 'Nama',
          theme: 'Tema',
          language: 'Bahasa',
          budgets: 'Anggaran (IDR)',
          dark: 'Gelap',
          light: 'Terang',
          editTransaction: 'Edit Transaksi',
          addTransaction: 'Tambah Transaksi',
          noTransactions: 'Belum ada transaksi',
          today: 'hari ini'
        , financialCharts: 'Grafik Keuangan'
        , projectedBalance: 'Proyeksi Saldo'
        , avatar: 'Avatar'
        , searchPlaceholder: 'Cari transaksi...'
        , noResults: 'Tidak ada transaksi ditemukan'
        , todayIncome: 'Pendapatan Hari Ini'
        , todayExpense: 'Pengeluaran Hari Ini'
        , sixMonthSummary: 'Pendapatan vs Pengeluaran 6 Bulan'
        , resetData: 'Setel Ulang Data'
        }
      };

      // In‑memory state
      let transactions = [];
      let settings = {
        name: 'Guest',
        theme: 'dark',
        language: 'en',
        avatar: 'user',
        budgets: { ...DEFAULT_BUDGETS }
      };
      let editingId = null;

      // Term used to filter transactions via the search bar
      let searchTerm = '';

      // --- Authentication & Login state ---
      // Predefined users.  These mirror the rules from the original index.html
      // file.  Passwords are stored here for demo purposes only.
      const validUsers = [
        { email: 'bias@budgeting.app', password: 'bias8145' },
        { email: 'icha@budgeting.app', password: 'bias8145' }
      ];
      let currentUser = null;
      let isGuestMode = false;

      /* ----- Persistence ----- */
      // Load state from Firestore for logged‑in users, otherwise from localStorage.  Returns a promise.
async function loadState() {
  try {
    let userKey = '';
    if (currentUser && !isGuestMode && currentUser.email) {
      userKey = '_' + currentUser.email;
    }
    
    // Load from localStorage first
    const localTx = localStorage.getItem('ebt_transactions' + userKey);
    transactions = localTx ? JSON.parse(localTx) : [];
    
    const localSettings = localStorage.getItem('ebt_settings' + userKey);
    if (localSettings) {
      settings = { ...settings, ...JSON.parse(localSettings) };
    }

    // Then try to load from Firestore if logged in
    if (currentUser && !isGuestMode) {
      const docRef = doc(db, 'users', currentUser.uid);
      const snap = await getDoc(docRef);
      
      if (snap.exists()) {
        const data = snap.data();
        transactions = data.transactions || transactions;
        settings = { ...settings, ...(data.settings || {}) };
        
        // Sync back to localStorage
        localStorage.setItem('ebt_transactions' + userKey, JSON.stringify(transactions));
        localStorage.setItem('ebt_settings' + userKey, JSON.stringify(settings));
      }
    }
  } catch (err) {
    console.error('Error loading state:', err);
    // Fallback to empty state if error occurs
    transactions = [];
    settings = { ...settings, budgets: { ...DEFAULT_BUDGETS } };
  }
}
      // Save transactions to Firestore for logged‑in users, otherwise to localStorage
      async function saveTransactions() {
        // Always persist transactions to localStorage using a key that includes the
        // user email when available.  This provides a reliable fallback if
        // Firestore writes fail or are restricted by security rules.
        let userKey = '';
        if (currentUser && !isGuestMode && currentUser.email) {
          userKey = '_' + currentUser.email;
        }
        localStorage.setItem('ebt_transactions' + userKey, JSON.stringify(transactions));
        if (currentUser && !isGuestMode) {
          try {
            // Save both transactions and settings together to reduce writes
            await setDoc(doc(db, 'users', currentUser.uid), { transactions, settings }, { merge: true });
          } catch (err) {
            console.error('Error saving transactions to Firestore', err);
          }
        }
      }
      // Save settings to Firestore for logged‑in users, otherwise to localStorage
      async function saveSettings() {
        // Always save settings locally under a key that incorporates the
        // user's email when available.  This ensures settings persist
        // across reloads even if Firestore rejects writes.
        let userKey = '';
        if (currentUser && !isGuestMode && currentUser.email) {
          userKey = '_' + currentUser.email;
        }
        localStorage.setItem('ebt_settings' + userKey, JSON.stringify(settings));
        if (currentUser && !isGuestMode) {
          try {
            await setDoc(doc(db, 'users', currentUser.uid), { settings }, { merge: true });
          } catch (err) {
            console.error('Error saving settings to Firestore', err);
          }
        }
      }

      /* ----- UI Helper Functions ----- */
      function setTheme(theme) {
        document.body.classList.toggle('light', theme === 'light');
        settings.theme = theme;
        saveSettings();
      }
      function setLanguage(lang) {
        settings.language = lang;
        saveSettings();
        updateText();
        renderBudgets();
        renderTransactions();
        generateInsights();
      }
      function updateText() {
        const t = TRANSLATIONS[settings.language];
        document.getElementById('availableBalanceLabel').textContent = t.availableBalance;
        document.getElementById('monthlyIncomeLabel').textContent = t.monthlyIncome;
        document.getElementById('monthlyExpenseLabel').textContent = t.monthlyExpense;
        document.getElementById('budgetGoalsTitle').textContent = t.budgetGoals;
        document.getElementById('viewAllBudgets').textContent = t.editBudgets;
        // Ensure the Edit Budgets button always opens the settings modal.  The
        // translation step updates the text on the button but does not
        // replace the DOM element, so we explicitly reassign the click
        // handler here.  Without this reassignment the event may be
        // dropped during re-render.
        const editBtn = document.getElementById('viewAllBudgets');
        if (editBtn) {
          editBtn.onclick = () => { window.openSettingsModal(); };
        }
        document.getElementById('aiTitle').textContent = t.aiInsights;
        document.getElementById('transactionsTitle').textContent = t.recentTransactions;
        document.getElementById('transactionModalTitle').textContent = editingId ? t.editTransaction : t.addTransaction;
        document.getElementById('labelType').textContent = t.type;
        document.getElementById('labelAmount').textContent = t.amount;
        document.getElementById('labelCategory').textContent = t.category;
        document.getElementById('labelDesc').textContent = t.description;
        document.getElementById('transactionCancel').textContent = t.cancel;
        document.getElementById('transactionSave').textContent = t.save;
        document.getElementById('settingsTitle').textContent = t.settings;
        document.getElementById('labelName').textContent = t.name;
        document.getElementById('labelTheme').textContent = t.theme;
        document.getElementById('labelLanguage').textContent = t.language;
        document.getElementById('labelBudgets').textContent = t.budgets;
        document.getElementById('labelAvatar').textContent = t.avatar;
        document.getElementById('settingsCancel').textContent = t.cancel;
        document.getElementById('settingsSave').textContent = t.save;
        // Update pill labels
        const pills = document.querySelectorAll('.filter-pill');
        pills[0].textContent = settings.language === 'en' ? 'All' : 'Semua';
        pills[1].textContent = settings.language === 'en' ? 'Income' : 'Pemasukan';
        pills[2].textContent = settings.language === 'en' ? 'Expense' : 'Pengeluaran';
        // Update quick action labels
        document.querySelector('#quickAddExpense .action-label').textContent = t.addExpense;
        document.querySelector('#quickAddIncome .action-label').textContent = t.addIncome;
        document.querySelector('#quickExport .action-label').textContent = t.export;
        document.querySelector('#quickSettings .action-label').textContent = t.settings;

        // Update charts section titles
        const chartsTitleEl = document.getElementById('chartsTitle');
        if (chartsTitleEl) chartsTitleEl.textContent = t.financialCharts;
        const estimationTitleEl = document.getElementById('estimationTitle');
        if (estimationTitleEl) estimationTitleEl.textContent = t.projectedBalance;

        // Update search placeholder and daily summary labels
        const searchInput = document.getElementById('transactionSearch');
        if (searchInput) searchInput.placeholder = t.searchPlaceholder;
        const dailyIncomeLabel = document.getElementById('dailyIncomeLabel');
        const dailyExpenseLabel = document.getElementById('dailyExpenseLabel');
        if (dailyIncomeLabel) dailyIncomeLabel.textContent = t.todayIncome;
        if (dailyExpenseLabel) dailyExpenseLabel.textContent = t.todayExpense;

        // Update Reset Data button text if it exists
        const resetBtn = document.getElementById('resetDataBtn');
        if (resetBtn) resetBtn.textContent = t.resetData;

        // Update logout button tooltip.  The logout button is icon-only,
        // so we use its title attribute for localisation.  If the button
        // exists, set its title based on the current language.
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.title = settings.language === 'en' ? 'Logout' : 'Keluar';
        }
      }

      function updateGreeting() {
        const now = new Date();
        const hour = now.getHours();
        let greeting;
        if (hour < 12) greeting = settings.language === 'en' ? 'Good Morning' : 'Selamat Pagi';
        else if (hour < 17) greeting = settings.language === 'en' ? 'Good Afternoon' : 'Selamat Siang';
        else if (hour < 21) greeting = settings.language === 'en' ? 'Good Evening' : 'Selamat Sore';
        else greeting = settings.language === 'en' ? 'Good Night' : 'Selamat Malam';
        document.getElementById('greetingMessage').textContent = `${greeting}, ${settings.name || 'Guest'}!`;
        document.getElementById('greetingSubtitle').textContent = settings.language === 'en' ? 'Ready to track your finances?' : 'Siap melacak keuangan Anda?';
        // Update the avatar icon and tooltip
        updateAvatar();
        document.getElementById('profileAvatar').title = settings.name || 'Guest';
      }

      // Update the avatar icon on the greeting card based on the selected
      // avatar in settings.  Uses the AVATAR_ICONS map.  If an
      // unknown avatar is selected, defaults to 'user'.
      function updateAvatar() {
        const avatarEl = document.getElementById('profileAvatar');
        // If a Google photo URL exists, use it as the avatar.  We wrap the image
        // in a circle to match the existing design.  Otherwise fall back to
        // the selected FontAwesome icon.
        if (settings.googlePhotoURL) {
          avatarEl.innerHTML = `<img src="${settings.googlePhotoURL}" alt="avatar" style="width:100%; height:100%; border-radius:50%;">`;
        } else {
          const key = settings.avatar || 'user';
          const icon = AVATAR_ICONS[key] || AVATAR_ICONS.user;
          avatarEl.innerHTML = `<i class="fas ${icon}"></i>`;
        }
      }

      /* ----- Transaction Operations ----- */
      function addTransaction(tx) {
        transactions.push(tx);
        saveTransactions();
      }
      function updateTransaction(id, updated) {
        const idx = transactions.findIndex(t => t.id === id);
        if (idx >= 0) {
          transactions[idx] = { ...transactions[idx], ...updated };
          saveTransactions();
        }
      }
      function deleteTransaction(id) {
        transactions = transactions.filter(t => t.id !== id);
        saveTransactions();
        renderTransactions();
        renderBudgets();
        generateInsights();
        updateSummary();
      }

      /* ----- Rendering Functions ----- */
      function updateSummary() {
        // Compute available balance, monthly income and expense
        const now = new Date();
        const currentMonth = now.getMonth();
        let balance = 0;
        let monthlyIncome = 0;
        let monthlyExpense = 0;
        transactions.forEach(t => {
          const d = new Date(t.date);
          const sign = t.type === 'expense' ? -1 : 1;
          balance += sign * t.amount;
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear()) {
            if (t.type === 'income') monthlyIncome += t.amount;
            else monthlyExpense += t.amount;
          }
        });
        document.getElementById('availableBalance').textContent = formatCurrency(balance);
        document.getElementById('monthlyIncome').textContent = `+${formatCurrency(monthlyIncome)}`;
        document.getElementById('monthlyExpense').textContent = `-${formatCurrency(monthlyExpense)}`;
        // Compute balance trend compared to previous month
        const prevMonth = (currentMonth - 1 + 12) % 12;
        let prevBalance = 0;
        transactions.forEach(t => {
          const d = new Date(t.date);
          const sign = t.type === 'expense' ? -1 : 1;
          if (d.getMonth() === prevMonth && d.getFullYear() === now.getFullYear()) {
            prevBalance += sign * t.amount;
          }
        });
        let trend = 0;
        if (prevBalance !== 0) trend = ((balance - prevBalance) / Math.abs(prevBalance)) * 100;
        document.getElementById('balanceTrendText').textContent = `${trend >= 0 ? '+' : ''}${trend.toFixed(1)}% ${settings.language === 'en' ? 'from last month' : 'dari bulan lalu'}`;
        const trendIcon = document.querySelector('#balanceTrend i');
        if (trend >= 0) {
          trendIcon.classList.remove('fa-trending-down');
          trendIcon.classList.add('fa-trending-up');
        } else {
          trendIcon.classList.remove('fa-trending-up');
          trendIcon.classList.add('fa-trending-down');
        }

        // After updating summary, refresh today's summary and charts
        updateDailySummary();
        renderCharts();
      }

      // Compute today's total income and expense and update the daily summary card
      function updateDailySummary() {
        const now = new Date();
        let incomeTotal = 0;
        let expenseTotal = 0;
        transactions.forEach(t => {
          const d = new Date(t.date);
          // Compare by date without time for the same day
          if (d.toDateString() === now.toDateString()) {
            if (t.type === 'income') incomeTotal += t.amount;
            else expenseTotal += t.amount;
          }
        });
        const incEl = document.getElementById('dailyIncome');
        const expEl = document.getElementById('dailyExpense');
        if (incEl) incEl.textContent = (incomeTotal > 0 ? '+' : '') + formatCurrency(incomeTotal);
        if (expEl) expEl.textContent = (expenseTotal > 0 ? '-' : '') + formatCurrency(expenseTotal);
      }

      function renderBudgets() {
        const container = document.getElementById('budgetCards');
        container.innerHTML = '';
        const now = new Date();
        const currentMonth = now.getMonth();
        const totalsByCategory = {};
        transactions.forEach(t => {
          const d = new Date(t.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear() && t.type === 'expense') {
            totalsByCategory[t.category] = (totalsByCategory[t.category] || 0) + t.amount;
          }
        });
        Object.keys(CATEGORY_META).forEach(cat => {
          const meta = CATEGORY_META[cat];
          // Determine the budget for this category.  Treat any non‑finite or
          // non‑positive values (including null or empty) as having no limit.
          let rawBudget = settings.budgets[cat];
          if (rawBudget === undefined) rawBudget = DEFAULT_BUDGETS[cat];
          let budget;
          if (typeof rawBudget !== 'number' || !isFinite(rawBudget) || rawBudget <= 0) {
            budget = Infinity;
          } else {
            budget = rawBudget;
          }
          const spent = totalsByCategory[cat] || 0;
          const ratio = budget === Infinity ? 0 : Math.min(spent / budget, 1);
          const percentage = budget === Infinity ? 0 : Math.min((spent / budget) * 100, 100);
          let progressClass = '';
          if (budget === Infinity) progressClass = 'progress-good';
          else if (ratio < 0.5) progressClass = 'progress-good';
          else if (ratio < 0.8) progressClass = 'progress-warning';
          else progressClass = 'progress-danger';
          const progressColor = progressClass === 'progress-good' ? 'var(--success-gradient)' : progressClass === 'progress-warning' ? 'var(--warning-gradient)' : 'var(--danger-gradient)';
          const budgetLimitText = budget === Infinity ? (settings.language === 'en' ? 'No limit' : 'Tanpa batas') : formatCurrency(budget);
          const card = document.createElement('div');
          card.className = 'budget-card';
          card.innerHTML = `
            <div class="budget-header">
              <div class="budget-category">
                <div class="category-icon" style="background:${progressColor};"><i class="fas ${meta.icon}"></i></div>
                <div class="category-info">
                  <h3>${meta.name[settings.language]}</h3>
                  <p>${settings.language === 'en' ? 'This month' : 'Bulan ini'}</p>
                </div>
              </div>
              <div class="budget-amount">
                <div class="spent-amount">${formatCurrency(spent)}</div>
                <div class="budget-limit">${budgetLimitText}</div>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar"><div class="progress-fill" style="background:${progressColor}; width:${percentage}%"></div></div>
              <div class="progress-percentage">${percentage.toFixed(0)}%</div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function renderTransactions() {
        const list = document.getElementById('transactionsList');
        list.innerHTML = '';
        const activeFilter = document.querySelector('.filter-pill.active').dataset.filter;
        // Apply type filter (income/expense/all)
        let filtered = transactions;
        if (activeFilter !== 'all') {
          filtered = transactions.filter(t => t.type === activeFilter);
        }
        // Apply search filter based on description, category name or amount
        if (searchTerm && searchTerm.trim() !== '') {
          filtered = filtered.filter(t => {
            const desc = t.description ? t.description.toLowerCase() : '';
            const catName = CATEGORY_META[t.category].name[settings.language].toLowerCase();
            const amountString = String(t.amount);
            return desc.includes(searchTerm) || catName.includes(searchTerm) || amountString.includes(searchTerm);
          });
        }
        if (filtered.length === 0) {
          const noEl = document.createElement('div');
          noEl.className = 'empty-message';
          noEl.style.textAlign = 'center';
          noEl.style.color = settings.theme === 'light' ? '#6b7280' : '#9ca3af';
          // If there are no transactions at all or search returned no results, show appropriate message
          noEl.textContent = searchTerm && searchTerm.trim() !== '' ? TRANSLATIONS[settings.language].noResults : TRANSLATIONS[settings.language].noTransactions;
          list.appendChild(noEl);
          return;
        }
        filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
        filtered.forEach(tx => {
          const card = document.createElement('div');
          card.className = 'transaction-card';
          const meta = CATEGORY_META[tx.category];
          // Determine background gradient by category for the icon
          const bgColor = meta.color;
          card.innerHTML = `
            <div class="transaction-content">
              <div class="transaction-icon" style="background:${bgColor};"><i class="fas ${meta.icon}"></i></div>
              <div class="transaction-details">
                <div class="transaction-title">${meta.name[settings.language]}</div>
                <div class="transaction-meta">
                  <span>${formatCurrency(tx.amount)}</span>
                  <span>${new Date(tx.date).toLocaleDateString(settings.language === 'en' ? 'en-US' : 'id-ID', { day:'numeric', month:'short', year:'numeric' })}</span>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount-value" style="color:${tx.type === 'income' ? '#4ade80' : '#f87171'}">${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.amount)}</div>
                <div class="amount-type">${settings.language === 'en' ? (tx.type === 'income' ? 'Income' : 'Expense') : (tx.type === 'income' ? 'Pemasukan' : 'Pengeluaran')}</div>
                <div class="transaction-actions">
                  <button class="txn-action-btn" data-id="${tx.id}" data-action="edit"><i class="fas fa-pen"></i></button>
                  <button class="txn-action-btn" data-id="${tx.id}" data-action="delete"><i class="fas fa-trash"></i></button>
                </div>
              </div>
            </div>
          `;
          list.appendChild(card);
        });
      }

      /* ----- Insights & Achievements ----- */
      function generateInsights() {
        const insightsContainer = document.getElementById('insightsList');
        insightsContainer.innerHTML = '';
        const now = new Date();
        const currentMonth = now.getMonth();
        // Gather total expenses by category for this month
        const totals = {};
        transactions.forEach(tx => {
          const d = new Date(tx.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear() && tx.type === 'expense') {
            totals[tx.category] = (totals[tx.category] || 0) + tx.amount;
          }
        });
        // Check budgets and generate tips
        Object.keys(CATEGORY_META).forEach(cat => {
          const spent = totals[cat] || 0;
          const budget = settings.budgets[cat] === undefined ? DEFAULT_BUDGETS[cat] : settings.budgets[cat];
          if (budget === Infinity) return;
          const ratio = spent / budget;
          const meta = CATEGORY_META[cat];
          if (ratio >= 0.8) {
            const item = document.createElement('div');
            item.className = 'insight-item';
            item.innerHTML = `
              <div class="insight-icon warning-icon"><i class="fas fa-exclamation-triangle"></i></div>
              <div class="insight-text">${settings.language === 'en'
                ? `You have used ${Math.round(ratio * 100)}% of your ${meta.name.en} budget.`
                : `Anda telah menggunakan ${Math.round(ratio * 100)}% dari anggaran ${meta.name.id}.`}</div>
            `;
            insightsContainer.appendChild(item);
          } else if (ratio <= 0.5 && spent > 0) {
            const item = document.createElement('div');
            item.className = 'insight-item';
            item.innerHTML = `
              <div class="insight-icon tip-icon"><i class="fas fa-check-circle"></i></div>
              <div class="insight-text">${settings.language === 'en'
                ? `Great! Only ${Math.round(ratio * 100)}% of your ${meta.name.en} budget used.`
                : `Bagus! Baru ${Math.round(ratio * 100)}% dari anggaran ${meta.name.id} terpakai.`}</div>
            `;
            insightsContainer.appendChild(item);
          }
        });
        // Show general savings tip if balance positive this month
        const thisMonthBalance = transactions.reduce((sum, tx) => {
          const d = new Date(tx.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear()) {
            return sum + (tx.type === 'income' ? tx.amount : -tx.amount);
          }
          return sum;
        }, 0);
        if (thisMonthBalance > 0) {
          const item = document.createElement('div');
          item.className = 'insight-item';
          item.innerHTML = `
            <div class="insight-icon trend-icon-small"><i class="fas fa-chart-line"></i></div>
            <div class="insight-text">${settings.language === 'en'
              ? 'Nice! You saved money this month.'
              : 'Bagus! Anda menabung bulan ini.'}</div>
          `;
          insightsContainer.appendChild(item);
        }
        if (insightsContainer.children.length === 0) {
          const item = document.createElement('div');
          item.className = 'insight-item';
          item.innerHTML = `
            <div class="insight-icon trend-icon-small"><i class="fas fa-lightbulb"></i></div>
            <div class="insight-text">${settings.language === 'en'
              ? 'Add some transactions to see insights.'
              : 'Tambahkan transaksi untuk melihat wawasan.'}</div>
          `;
          insightsContainer.appendChild(item);
        }
      }

      function checkAchievements(newTx) {
        // Example achievement: first transaction added
        if (transactions.length === 1) {
          showAchievement(settings.language === 'en' ? 'First Transaction' : 'Transaksi Pertama', settings.language === 'en' ? 'You added your first transaction.' : 'Anda menambahkan transaksi pertama.');
        }
        // Achievement: staying under 50% of all budgets this month
        const now = new Date();
        const currentMonth = now.getMonth();
        const totals = {};
        transactions.forEach(tx => {
          const d = new Date(tx.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear() && tx.type === 'expense') {
            totals[tx.category] = (totals[tx.category] || 0) + tx.amount;
          }
        });
        let allUnderHalf = true;
        for (const cat in CATEGORY_META) {
          const budget = settings.budgets[cat] === undefined ? DEFAULT_BUDGETS[cat] : settings.budgets[cat];
          if (budget !== Infinity) {
            const ratio = (totals[cat] || 0) / budget;
            if (ratio > 0.5) { allUnderHalf = false; break; }
          }
        }
        if (allUnderHalf && transactions.length > 0) {
          showAchievement(settings.language === 'en' ? 'Budget Master' : 'Ahli Anggaran', settings.language === 'en' ? 'All categories under 50% of budget.' : 'Semua kategori di bawah 50% anggaran.');
        }
      }
      function showAchievement(title, message) {
        const popup = document.getElementById('achievementPopup');
        document.getElementById('achievementTitle').textContent = title;
        document.getElementById('achievementMessage').textContent = message;
        popup.classList.add('show');
        setTimeout(() => { popup.classList.remove('show'); }, 5000);
      }

      /* ----- Modal controls ----- */
      function openTransactionModal(editId = null) {
        editingId = editId;
        document.getElementById('transactionModalTitle').textContent = TRANSLATIONS[settings.language][editId ? 'editTransaction' : 'addTransaction'];
        document.getElementById('transactionType').value = editId ? transactions.find(t => t.id === editId).type : 'expense';
        document.getElementById('transactionAmount').value = editId ? transactions.find(t => t.id === editId).amount : '';
        document.getElementById('transactionCategory').value = editId ? transactions.find(t => t.id === editId).category : 'food';
        document.getElementById('transactionDesc').value = editId ? transactions.find(t => t.id === editId).description : '';
        document.getElementById('transactionModal').classList.add('active');
      }
      function closeTransactionModal() {
        editingId = null;
        document.getElementById('transactionModal').classList.remove('active');
      }
      function openSettingsModal() {
        // Prefill settings inputs
        document.getElementById('userName').value = settings.name;
        document.getElementById('themeSelect').value = settings.theme;
        document.getElementById('languageSelect').value = settings.language;
        // Generate budget inputs
        const container = document.getElementById('budgetInputs');
        container.innerHTML = '';
        Object.keys(CATEGORY_META).forEach(cat => {
          const label = document.createElement('label');
          label.className = 'form-label';
          label.textContent = CATEGORY_META[cat].name[settings.language];
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.className = 'form-input';
          input.value = settings.budgets[cat] === Infinity ? '' : settings.budgets[cat];
          input.placeholder = CATEGORY_META[cat].name[settings.language];
          input.dataset.cat = cat;
          const group = document.createElement('div');
          group.className = 'form-group';
          group.appendChild(label);
          group.appendChild(input);
          container.appendChild(group);
        });
        document.getElementById('settingsModal').classList.add('active');
        // Determine if the current user signed in via Google.  If so,
        // hide the avatar selection and show an informational message that
        // the avatar comes from the Google profile.  Otherwise show the
        // avatar options and highlight the selected one.
        const avatarContainer = document.getElementById('avatarOptions');
        const avatarGroup = avatarContainer ? avatarContainer.parentElement : null;
        const msgId = 'googleAvatarMsg';
        let msgEl = document.getElementById(msgId);
        const isGoogleLogin = currentUser && !isGuestMode && currentUser.providerData && currentUser.providerData.some(p => p.providerId === 'google.com');
        if (isGoogleLogin && settings.googlePhotoURL) {
          if (avatarContainer) avatarContainer.style.display = 'none';
          if (!msgEl) {
            msgEl = document.createElement('p');
            msgEl.id = msgId;
            msgEl.style.fontSize = '12px';
            msgEl.style.marginTop = '8px';
            msgEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-dark');
            if (avatarGroup) avatarGroup.appendChild(msgEl);
          }
          msgEl.textContent = settings.language === 'en'
            ? 'Avatar is taken from your Google profile'
            : 'Avatar Anda diambil dari profil Google';
        } else {
          if (avatarContainer) avatarContainer.style.display = 'flex';
          if (msgEl) msgEl.remove();
          const avatarOptions = document.querySelectorAll('#avatarOptions .avatar-option');
          avatarOptions.forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.avatar === settings.avatar);
          });
        }
      }
      function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('active');
      }

      /*
       * Navigate between logical pages.  Each major section on the
       * dashboard (balance card, budgets, quick actions, AI insights) is
       * tagged with a data-page attribute (dashboard, charts or
       * transactions).  This function shows only the selected page and
       * hides the others.  The header remains visible on all pages.
       */
      function navigateTo(page) {
        document.querySelectorAll('[data-page]').forEach(el => {
          el.style.display = el.getAttribute('data-page') === page ? '' : 'none';
        });
        // When navigating to charts or transactions, re-render relevant
        // components if needed.  This ensures charts and summaries are
        // up to date after the user adds or edits data on another page.
        if (page === 'charts') {
          renderCharts();
        } else if (page === 'transactions') {
          renderTransactions();
        } else if (page === 'dashboard') {
          renderBudgets();
          generateInsights();
          updateSummary();
        }
      }

      // Expose certain functions globally so they can be invoked from
      // inline HTML attributes (e.g. onclick) and from outside this
      // closure.  Without this, the functions are scoped to this IIFE
      // and cannot be resolved when called from the DOM.
      window.openSettingsModal = openSettingsModal;
      window.closeSettingsModal = closeSettingsModal;
      window.navigateTo = navigateTo;

      //
      // Reposition quick actions above the AI insights panel on the dashboard.
      // The original markup places the quick actions after the budget goals,
      // which pushes them far down the page.  For easier access we move the
      // `.quick-actions` element before the `.ai-insights` element at runtime.
      // This helper is idempotent and will only reposition if necessary.
      function repositionQuickActions() {
        const ai = document.querySelector('.ai-insights[data-page="dashboard"]');
        const qa = document.querySelector('.quick-actions[data-page="dashboard"]');
        if (ai && qa && ai.parentNode) {
          // If quick actions are not already immediately before AI insights,
          // insert them there.
          if (qa.nextElementSibling !== ai) {
            ai.parentNode.insertBefore(qa, ai);
          }
        }
      }
      // Expose repositionQuickActions globally so it can be called from other scopes
      window.repositionQuickActions = repositionQuickActions;

      /* ----- Event Handlers ----- */
      function handleTransactionSave() {
        const type = document.getElementById('transactionType').value;
        const amount = parseInt(document.getElementById('transactionAmount').value);
        const category = document.getElementById('transactionCategory').value;
        const desc = document.getElementById('transactionDesc').value.trim();
        if (!amount || amount <= 0 || isNaN(amount)) {
          // Use custom alert panel for validation errors
          const msg = settings.language === 'en' ? 'Enter a valid amount' : 'Masukkan jumlah yang valid';
          openAlert(msg);
          return;
        }
        if (!desc) {
          const msg = settings.language === 'en' ? 'Enter description' : 'Masukkan deskripsi';
          openAlert(msg);
          return;
        }
        if (editingId) {
          updateTransaction(editingId, { type, amount, category, description: desc, date: new Date().toISOString() });
        } else {
          const newTx = { id: Date.now().toString(), type, amount, category, description: desc, date: new Date().toISOString() };
          addTransaction(newTx);
          checkAchievements(newTx);
        }
        closeTransactionModal();
        renderTransactions();
        renderBudgets();
        generateInsights();
        updateSummary();
      }
      function handleSettingsSave() {
        settings.name = document.getElementById('userName').value.trim() || 'Guest';
        const newTheme = document.getElementById('themeSelect').value;
        const newLang = document.getElementById('languageSelect').value;
        // Save budgets
        const inputs = document.querySelectorAll('#budgetInputs input');
        inputs.forEach(inp => {
          const cat = inp.dataset.cat;
          const val = inp.value.trim();
          settings.budgets[cat] = val === '' ? Infinity : parseInt(val);
        });
        saveSettings();
        setTheme(newTheme);
        setLanguage(newLang);
        updateGreeting();
        renderBudgets();
        renderTransactions();
        generateInsights();
        updateSummary();
        closeSettingsModal();
      }
      function initEventListeners() {
        // Quick action events
        document.getElementById('quickAddExpense').addEventListener('click', () => openTransactionModal(null));
        document.getElementById('quickAddIncome').addEventListener('click', () => {
          openTransactionModal(null);
          document.getElementById('transactionType').value = 'income';
        });
        document.getElementById('quickExport').addEventListener('click', () => {
          // Ask the user which format to export.  If they confirm, a CSV
          // file will be generated; otherwise, a JSON backup is created.
          const msg = settings.language === 'en'
            ? 'Export as CSV?\nClick Cancel for JSON.'
            : 'Ekspor sebagai CSV?\nKlik Batal untuk JSON.';
          const asCsv = confirm(msg);
          if (asCsv) {
            // Build CSV string with a header row.  Description fields are
            // enclosed in double quotes and any quotes inside are
            // doubled to escape them.  This allows spreadsheet
            // applications to parse the file correctly.
            let csv = 'id,type,amount,category,description,date\n';
            transactions.forEach(tx => {
              const desc = (tx.description || '').replace(/"/g, '""');
              csv += `${tx.id},${tx.type},${tx.amount},${tx.category},"${desc}",${tx.date}\n`;
            });
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions.csv';
            a.click();
            URL.revokeObjectURL(url);
          } else {
            const data = JSON.stringify(transactions);
            const blob = new Blob([data], { type:'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions.json';
            a.click();
            URL.revokeObjectURL(url);
          }
        });
        document.getElementById('quickSettings').addEventListener('click', openSettingsModal);
        // The floating add button has been replaced by the navigation menu.  If it still exists, hide it.
        const floatBtn = document.getElementById('floatingAdd');
        if (floatBtn) {
          floatBtn.style.display = 'none';
          floatBtn.addEventListener('click', () => openTransactionModal(null));
        }
        // Filter pills
        document.getElementById('filterPills').addEventListener('click', e => {
          const pill = e.target.closest('.filter-pill');
          if (!pill) return;
          document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
          pill.classList.add('active');
          renderTransactions();
        });

        // Search bar input
        const searchInput = document.getElementById('transactionSearch');
        if (searchInput) {
          searchInput.addEventListener('input', e => {
            searchTerm = e.target.value.toLowerCase();
            renderTransactions();
          });
        }
        // Transaction actions (edit/delete)
        document.getElementById('transactionsList').addEventListener('click', e => {
          const btn = e.target.closest('.txn-action-btn');
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          if (action === 'edit') {
            openTransactionModal(id);
          } else if (action === 'delete') {
            const msg = settings.language === 'en' ? 'Delete this transaction?' : 'Hapus transaksi ini?';
            showConfirm(msg, () => {
              deleteTransaction(id);
            });
          }
        });
        // Modal buttons
        document.getElementById('transactionCancel').addEventListener('click', closeTransactionModal);
        document.getElementById('transactionSave').addEventListener('click', handleTransactionSave);
        document.getElementById('settingsCancel').addEventListener('click', closeSettingsModal);
        document.getElementById('settingsSave').addEventListener('click', handleSettingsSave);

        // Reset data button: clears all transactions and resets budgets.  Uses
        // the custom confirmation modal to avoid accidental data loss.
        const resetBtn = document.getElementById('resetDataBtn');
        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            const msg = settings.language === 'en'
              ? 'Are you sure you want to reset all data? This will delete all transactions and restore default budgets.'
              : 'Anda yakin ingin menghapus semua data? Ini akan menghapus semua transaksi dan mengembalikan anggaran ke nilai awal.';
            showConfirm(msg, () => {
              // Clear local transactions and reset budgets to defaults
              transactions = [];
              settings.budgets = { ...DEFAULT_BUDGETS };
              saveTransactions();
              saveSettings();
              updateSummary();
              renderBudgets();
              renderTransactions();
              generateInsights();
              renderCharts();
              updateGreeting();
              closeSettingsModal();
            });
          });
        }

        // Back bars: clicking on the horizontal back bar navigates to the dashboard.
        const chartsBackBar = document.getElementById('chartsBackBar');
        if (chartsBackBar) {
          chartsBackBar.addEventListener('click', () => {
            navigateTo('dashboard');
          });
        }
        const transactionsBackBar = document.getElementById('transactionsBackBar');
        if (transactionsBackBar) {
          transactionsBackBar.addEventListener('click', () => {
            navigateTo('dashboard');
          });
        }
        // Clicking outside modal closes it
        document.querySelectorAll('.modal').forEach(modal => {
          modal.addEventListener('click', e => {
            if (e.target === modal) modal.classList.remove('active');
          });
        });

        // Login modal buttons
        document.getElementById('loginBtnEmail').addEventListener('click', loginWithEmail);
        document.getElementById('guestBtn').addEventListener('click', loginAsGuest);
        const googleBtn = document.getElementById('loginBtnGoogle');
        if (googleBtn) googleBtn.addEventListener('click', loginWithGoogle);

        // Avatar option click events
        const avatarOptions = document.querySelectorAll('#avatarOptions .avatar-option');
        avatarOptions.forEach(opt => {
          opt.addEventListener('click', () => {
            // If the avatar is tied to a Google profile, prevent manual selection
            if (settings.googlePhotoURL) {
              openAlert(settings.language === 'en'
                ? 'Your avatar is set by your Google profile.'
                : 'Avatar Anda diatur oleh profil Google Anda.');
              return;
            }
            // Remove selected class from all and add to clicked
            avatarOptions.forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            // Update setting when user selects an avatar
            settings.avatar = opt.dataset.avatar;
          });
        });

        // Logout button event
        const logoutBtnEl = document.getElementById('logoutBtn');
        if (logoutBtnEl) {
          logoutBtnEl.addEventListener('click', () => {
            // Close the navigation menu before showing the confirmation.  When the menu
            // remains open it can partially obscure the confirm buttons.
            const navMenuEl = document.getElementById('navMenu');
            const navOverlayEl = document.getElementById('navOverlay');
            if (navMenuEl && navOverlayEl) {
              navMenuEl.classList.remove('open');
              navOverlayEl.classList.remove('show');
            }
            const message = settings.language === 'en'
              ? 'Are you sure you want to log out?'
              : 'Anda yakin ingin keluar?';
            showConfirm(message, async () => {
              await handleLogout();
            });
          });
        }

        // Bind Edit Budgets button to open settings modal
        const editBudBtn = document.getElementById('viewAllBudgets');
        if (editBudBtn) {
          editBudBtn.addEventListener('click', openSettingsModal);
        }

        // As a fallback, use event delegation on the document to
        // capture clicks on the Edit Budgets button.  This ensures
        // that even if the element is re-rendered or its handlers are
        // lost during translation, clicking it will still open the
        // settings modal.
        document.addEventListener('click', e => {
          const btn = e.target.closest('#viewAllBudgets');
          if (btn) {
            openSettingsModal();
          }
        });

        // Navigation menu events
        const navMenu = document.getElementById('navMenu');
        const navToggle = document.getElementById('navToggle');
        const navOverlay = document.getElementById('navOverlay');
        if (navToggle && navMenu && navOverlay) {
          navToggle.addEventListener('click', () => {
            const open = navMenu.classList.toggle('open');
            if (open) {
              navOverlay.classList.add('show');
            } else {
              navOverlay.classList.remove('show');
            }
          });
          navOverlay.addEventListener('click', () => {
            navMenu.classList.remove('open');
            navOverlay.classList.remove('show');
          });
          document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
              const target = btn.getAttribute('data-target');
              if (typeof navigateTo === 'function') navigateTo(target);
              navMenu.classList.remove('open');
              navOverlay.classList.remove('show');
            });
          });
        }
      }

      /* ----- Initialisation ----- */
      function init() {
        // Attempt to restore user or guest session
        const storedUser = localStorage.getItem('enhanced_user');
        const storedGuest = localStorage.getItem('enhanced_guest');
        if (storedUser) {
          try {
            const userObj = JSON.parse(storedUser);
            currentUser = userObj;
            isGuestMode = false;
            settings.name = userObj.email.split('@')[0];
          } catch (e) { /* ignore */ }
        } else if (storedGuest) {
          isGuestMode = true;
          currentUser = null;
          settings.name = 'Guest';
        }
        loadState();
        setTheme(settings.theme);
        setLanguage(settings.language);
        updateGreeting();
        updateSummary();
        renderBudgets();
        renderTransactions();
        generateInsights();
        renderCharts();
        // Default to dashboard page on initial load
        navigateTo('dashboard');
        // Move quick actions above AI insights after initial render
        if (typeof repositionQuickActions === 'function') repositionQuickActions();
        initEventListeners();
        // Update greeting every minute
        setInterval(updateGreeting, 60000);
        // If no user or guest session, prompt login
        if (!storedUser && !storedGuest) {
          openLoginModal();
        }
        // Clicking outside the alert panel closes it
        const alertPanel = document.getElementById('alertPanel');
        if (alertPanel) {
          alertPanel.addEventListener('click', (e) => {
            if (e.target === alertPanel) closeAlert();
          });
        }
      }
      init();

      // Listen for Firebase authentication changes and update state accordingly
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // User is signed in
    currentUser = user;
    isGuestMode = false;
    settings.name = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
    settings.googlePhotoURL = user.photoURL || null;
    localStorage.setItem('enhanced_user', JSON.stringify({ 
      uid: user.uid, 
      email: user.email,
      displayName: user.displayName,
      photoURL: user.photoURL
    }));
    await loadState();
    // Pastikan data sudah dimuat sebelum render
    updateUI();
  } else {
    // User is signed out
    handleGuestMode();
  }
});

async function updateUI() {
  setTheme(settings.theme);
  setLanguage(settings.language);
  updateGreeting();
  updateSummary();
  renderBudgets();
  renderTransactions();
  generateInsights();
  renderCharts();
}

function handleGuestMode() {
  currentUser = null;
  isGuestMode = true;
  settings.name = 'Guest';
  settings.googlePhotoURL = null;
  localStorage.setItem('enhanced_guest', 'true');
  loadState().then(updateUI);
}

      /* ----- Custom Confirm Modal ----- */
      function openConfirmModal() {
        document.getElementById('confirmModal').classList.add('active');
      }
      function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
      }
      // Display a confirmation dialog with given message.  Executes callback on confirm.
      function showConfirm(message, onConfirm) {
        const msgEl = document.getElementById('confirmMessage');
        msgEl.textContent = message;
        const yesBtn = document.getElementById('confirmYes');
        const noBtn = document.getElementById('confirmNo');
        // Clear previous handlers
        yesBtn.onclick = null;
        noBtn.onclick = null;
        yesBtn.onclick = () => {
          // Close the confirmation modal and perform the confirmed action
          closeConfirmModal();
          if (typeof onConfirm === 'function') onConfirm();
          // After confirming, always navigate back to the dashboard and
          // reposition quick actions to ensure the UI is fully restored.
          if (typeof navigateTo === 'function') navigateTo('dashboard');
          if (typeof repositionQuickActions === 'function') repositionQuickActions();
        };
        noBtn.onclick = () => {
          // Close the confirmation modal.  Navigating back to the dashboard
          // ensures that any residual overlays or blurred backgrounds
          // introduced by the confirmation are removed.  Without this the
          // user may be left staring at a dimmed page with only the
          // greeting visible (see bug report #8).
          closeConfirmModal();
          if (typeof navigateTo === 'function') navigateTo('dashboard');
          if (typeof repositionQuickActions === 'function') repositionQuickActions();
        };
        openConfirmModal();
      }

      /* ----- Custom Alert Panel ----- */
      // Display an alert with the specified message.  Unlike the native
      // alert() this maintains the look and feel of the app.  The panel
      // automatically adapts to the current light/dark theme.
      function openAlert(message) {
        const panel = document.getElementById('alertPanel');
        const msgEl = document.getElementById('alertMessage');
        const okBtn = document.getElementById('alertOk');
        msgEl.textContent = message;
        // Translate the button label based on current language
        okBtn.textContent = settings.language === 'en' ? 'OK' : 'Tutup';
        // Remove previous handlers to avoid duplication
        okBtn.onclick = null;
        okBtn.onclick = () => {
          closeAlert();
        };
        panel.classList.add('active');
      }
      function closeAlert() {
        const panel = document.getElementById('alertPanel');
        panel.classList.remove('active');
      }

      /* ----- Authentication Functions ----- */
      function openLoginModal() {
        document.getElementById('loginModal').classList.add('active');
      }
      function closeLoginModal() {
        document.getElementById('loginModal').classList.remove('active');
      }
      function loginWithEmail() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const user = validUsers.find(u => u.email === email && u.password === password);
        if (user) {
          currentUser = user;
          isGuestMode = false;
          settings.name = email.split('@')[0];
          // Clear any Google photo when logging in via email/password
          settings.googlePhotoURL = null;
          localStorage.setItem('enhanced_user', JSON.stringify(user));
          localStorage.removeItem('enhanced_guest');
          closeLoginModal();
          // Reload transactions for this user and re-render
          loadState();
          setTheme(settings.theme);
          setLanguage(settings.language);
          updateGreeting();
          updateSummary();
          renderBudgets();
          renderTransactions();
          generateInsights();
          renderCharts();
          // After a successful email/password login always return to the
          // dashboard so the user starts from a known state.  Also
          // reposition the quick actions in case the DOM has changed.
          navigateTo('dashboard');
          if (typeof repositionQuickActions === 'function') repositionQuickActions();
        } else {
          // Show a themed alert rather than the native browser alert
          const msg = settings.language === 'en' ? 'Invalid credentials' : 'Email atau kata sandi salah';
          openAlert(msg);
        }
      }

      // Sign in with Google using Firebase Auth
      async function loginWithGoogle() {
        try {
          const result = await signInWithPopup(auth, googleProvider);
          const user = result.user;
          currentUser = user;
          isGuestMode = false;
          // Use either the displayName or email prefix as the user's name
          settings.name = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
          // Store the Google profile photo so that the avatar matches the account
          settings.googlePhotoURL = user.photoURL || null;
          // Persist sign in across reloads
          localStorage.setItem('enhanced_user', JSON.stringify({ uid: user.uid, email: user.email }));
          localStorage.removeItem('enhanced_guest');
          closeLoginModal();
          // Load any previously saved data.  After loadState returns, we
          // explicitly restore the Google photo (loadState may reset it).
          await loadState();
          settings.googlePhotoURL = user.photoURL || settings.googlePhotoURL || null;
          // Persist settings (including googlePhotoURL) immediately
          await saveSettings();
          setTheme(settings.theme);
          setLanguage(settings.language);
          updateGreeting();
          updateSummary();
          renderBudgets();
          renderTransactions();
          generateInsights();
          renderCharts();
          // After a successful Google login return to the dashboard and
          // reposition the quick actions for accessibility.  Without this the
          // previous page (e.g. charts or transactions) may remain visible.
          navigateTo('dashboard');
          if (typeof repositionQuickActions === 'function') repositionQuickActions();
        } catch (error) {
          console.error('Google sign-in error', error);
          // Display the error using our custom alert panel
          const msg = settings.language === 'en' ? 'Google sign-in failed' : 'Login Google gagal';
          openAlert(msg);
        }
      }
      function loginAsGuest() {
        currentUser = null;
        isGuestMode = true;
        settings.name = 'Guest';
        // Clear any Google photo when switching to guest mode
        settings.googlePhotoURL = null;
        localStorage.setItem('enhanced_guest', 'true');
        localStorage.removeItem('enhanced_user');
        closeLoginModal();
        // Reload local state and re-render
        loadState();
        setTheme(settings.theme);
        setLanguage(settings.language);
        updateGreeting();
        updateSummary();
        renderBudgets();
        renderTransactions();
        generateInsights();
        renderCharts();
        // After entering guest mode ensure the dashboard is displayed and
        // reposition quick actions so they appear above AI insights.
        navigateTo('dashboard');
        if (typeof repositionQuickActions === 'function') repositionQuickActions();
      }

      // Log the user out of the current session.  When invoked, this will sign
      // out of Firebase (if a Google user), clear local session state and
      // return the application to guest mode.  The UI is refreshed and the
      // login modal is opened so the user can choose how to proceed.
      async function handleLogout() {
        try {
          if (auth && auth.currentUser) {
            await signOut(auth);
          }
        } catch (err) {
          console.error('Logout error', err);
        }
        currentUser = null;
        isGuestMode = true;
        // Reset basic user settings so that a subsequent session starts fresh
        settings.name = 'Guest';
        settings.avatar = 'user';
        settings.googlePhotoURL = null;
        // Remove any stored user or guest session flags
        localStorage.removeItem('enhanced_user');
        localStorage.removeItem('enhanced_guest');
        // Clear all persisted budgets and transaction data so no previous
        // user data leaks into the new session
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('ebt_transactions') || key.startsWith('ebt_settings')) {
            localStorage.removeItem(key);
          }
        });
        await loadState();
        setTheme(settings.theme);
        setLanguage(settings.language);
        updateGreeting();
        updateSummary();
        renderBudgets();
        renderTransactions();
        generateInsights();
        renderCharts();
        // Always return to the dashboard after logout and reposition quick actions
        navigateTo('dashboard');
        if (typeof repositionQuickActions === 'function') repositionQuickActions();
        // Prompt the user to sign in again or continue as guest
        openLoginModal();
      }

      /* ----- Chart Rendering & Estimation ----- */
      function renderCharts() {
        renderIncomeExpenseChart();
        renderCategoryPieChart();
        renderBalanceTrendChart();
        // Render a rolling six‑month summary comparing income and expense
        renderMonthlySummaryChart();
        renderEstimation();
      }
      function renderIncomeExpenseChart() {
        // Compute monthly income and expense for current month
        const now = new Date();
        const currentMonth = now.getMonth();
        let incomeTotal = 0;
        let expenseTotal = 0;
        transactions.forEach(tx => {
          const d = new Date(tx.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear()) {
            if (tx.type === 'income') incomeTotal += tx.amount; else expenseTotal += tx.amount;
          }
        });
        const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
        const existing = Chart.getChart(ctx);
        if (existing) existing.destroy();
        const t = TRANSLATIONS[settings.language];
        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: [t.monthlyIncome, t.monthlyExpense],
            datasets: [{
              label: t.availableBalance,
              data: [incomeTotal, expenseTotal],
              backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim(), getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim()],
              borderColor: [getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim(), getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim()],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `${t.monthlyIncome} vs ${t.monthlyExpense}`,
                color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim(),
                font: { size: 14, weight: '700' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim(),
                  callback: function(value) { return formatCurrency(value); }
                },
                grid: { color: document.body.classList.contains('light') ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.1)' }
              },
              x: {
                ticks: { color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim() },
                grid: { display: false }
              }
            }
          }
        });
      }
      function renderCategoryPieChart() {
        // Compute totals by category for current month
        const now = new Date();
        const currentMonth = now.getMonth();
        const totals = {};
        transactions.forEach(tx => {
          const d = new Date(tx.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === now.getFullYear() && tx.type === 'expense') {
            totals[tx.category] = (totals[tx.category] || 0) + tx.amount;
          }
        });
        const ctx = document.getElementById('categoryPieChart').getContext('2d');
        const existing = Chart.getChart(ctx);
        if (existing) existing.destroy();
        if (Object.keys(totals).length === 0) {
          // Draw placeholder text
          ctx.font = '14px DM Sans';
          ctx.fillStyle = document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-dark').trim();
          ctx.textAlign = 'center';
          ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
          ctx.fillText(settings.language === 'en' ? 'No expenses this month' : 'Belum ada pengeluaran bulan ini', ctx.canvas.width / 2, ctx.canvas.height / 2);
          return;
        }
        const labels = Object.keys(totals).map(cat => CATEGORY_META[cat].name[settings.language]);
        const data = Object.values(totals);
        const colors = Object.keys(totals).map(cat => CATEGORY_META[cat].color);
        // Render as a doughnut chart with a modest cutout for improved aesthetics.
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{ data: data, backgroundColor: colors, borderColor: colors, borderWidth: 1 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim(),
                  font: { size: 12 }
                }
              },
              title: {
                display: true,
                text: settings.language === 'en' ? 'Expenses by Category (This Month)' : 'Pengeluaran per Kategori (Bulan Ini)',
                color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim(),
                font: { size: 14, weight: '700' }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) label += ': ';
                    label += formatCurrency(context.raw);
                    return label;
                  }
                }
              }
            }
          }
        });
      }
      function renderBalanceTrendChart() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const balances = [];
        const labels = [];
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(currentYear, currentMonth, day);
          let balance = 0;
          transactions.forEach(tx => {
            const txDate = new Date(tx.date);
            if (txDate <= date) {
              balance += tx.type === 'income' ? tx.amount : -tx.amount;
            }
          });
          balances.push(balance);
          labels.push(day);
        }
        const ctx = document.getElementById('balanceTrendChart').getContext('2d');
        const existing = Chart.getChart(ctx);
        if (existing) existing.destroy();
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: settings.language === 'en' ? 'Balance' : 'Saldo',
              data: balances,
              borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
              backgroundColor: hexToRgba(getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(), 0.3),
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: settings.language === 'en' ? 'Balance Trend (This Month)' : 'Tren Saldo (Bulan Ini)',
                color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim(),
                font: { size: 14, weight: '700' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => formatCurrency(value),
                  color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim()
                },
                grid: { color: document.body.classList.contains('light') ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.1)' }
              },
              x: {
                ticks: {
                  color: document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim()
                },
                grid: { display: false }
              }
            }
          }
        });
      }

      // Render a six‑month summary bar chart comparing monthly income and expense.
      function renderMonthlySummaryChart() {
        const now = new Date();
        const labels = [];
        const incomes = [];
        const expenses = [];
        // Generate arrays for the last six months (including current month)
        for (let i = 5; i >= 0; i--) {
          const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
          // Month abbreviation based on user language (e.g. Jan, Feb or Jan, Feb in Indonesian locale)
          const locale = settings.language === 'en' ? 'en-US' : 'id-ID';
          const monthLabel = date.toLocaleString(locale, { month: 'short' });
          labels.push(monthLabel);
          // Sum income and expense for each month
          let incomeSum = 0;
          let expenseSum = 0;
          transactions.forEach(tx => {
            const txDate = new Date(tx.date);
            if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
              if (tx.type === 'income') incomeSum += tx.amount; else expenseSum += tx.amount;
            }
          });
          incomes.push(incomeSum);
          expenses.push(expenseSum);
        }
        const ctx = document.getElementById('monthlySummaryChart').getContext('2d');
        const existing = Chart.getChart(ctx);
        if (existing) existing.destroy();
        // Determine colours based on CSS variables for theme consistency
        const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
        const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim();
        const textColor = document.body.classList.contains('light') ? getComputedStyle(document.documentElement).getPropertyValue('--text-primary-light').trim() : getComputedStyle(document.documentElement).getPropertyValue('--text-primary-dark').trim();
        const gridColor = document.body.classList.contains('light') ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.1)';
        const t = TRANSLATIONS[settings.language];
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: t.monthlyIncome,
                data: incomes,
                backgroundColor: successColor,
                borderColor: successColor,
                borderWidth: 1
              },
              {
                label: t.monthlyExpense,
                data: expenses,
                backgroundColor: dangerColor,
                borderColor: dangerColor,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: textColor, font: { size: 12 } }
              },
              title: {
                display: true,
                text: t.sixMonthSummary,
                color: textColor,
                font: { size: 14, weight: '700' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: textColor,
                  callback: function(value) { return formatCurrency(value); }
                },
                grid: { color: gridColor }
              },
              x: {
                ticks: { color: textColor },
                grid: { display: false }
              }
            }
          }
        });
      }
      // Helper to convert hex colour to rgba with given alpha
      function hexToRgba(hex, alpha) {
        const c = hex.replace('#','');
        const bigint = parseInt(c, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r},${g},${b},${alpha})`;
      }
      function renderEstimation() {
        // Project end‑of‑month balance based on average net daily change so far
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const dayOfMonth = now.getDate();
        // Compute net so far this month
        let net = 0;
        transactions.forEach(tx => {
          const d = new Date(tx.date);
          if (d.getMonth() === currentMonth && d.getFullYear() === currentYear && d.getDate() <= dayOfMonth) {
            net += tx.type === 'income' ? tx.amount : -tx.amount;
          }
        });
        // Average daily change
        const avgDaily = dayOfMonth === 0 ? 0 : net / dayOfMonth;
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const projectedNet = avgDaily * daysInMonth;
        // Compute total balance to date
        let cumulativeBalance = 0;
        transactions.forEach(tx => {
          if (new Date(tx.date) <= now) {
            cumulativeBalance += tx.type === 'income' ? tx.amount : -tx.amount;
          }
        });
        const projectedBalance = cumulativeBalance + (projectedNet - net);
        const estEl = document.getElementById('estimationText');
        estEl.textContent = `${settings.language === 'en' ? 'Estimated end of month balance' : 'Perkiraan saldo akhir bulan'}: ${formatCurrency(projectedBalance)}`;
      }
    })();
  </script>
</body>
</html>